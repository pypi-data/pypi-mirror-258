<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>sServer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="/01HKRR94VNQMZWSKD2ESGXQK55" type="text/css"> -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/dropzone/5.9.2/dropzone.min.css">
    <link rel="shortcut icon" href="/favicon.ico">
</head>

<body>
    <div class="container-fluid">
        <!-- 文件列表 -->
        <div style="height: 50vh; overflow-y: auto;">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Created At</th>
                        <th>Size</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="files">
                    {% for file in files %}
                    <tr>
                        <td><a href="{{ url_for('app.download', fid=file.id) }}" target="_blank">{{ file.original_name
                                }}</a></td>
                        <td>{{ file.created_at|datetime_format }}</td>
                        <td>{{ file.size|format_size }}</td>
                        <td>
                            <a href="{{ url_for('app.delete', mode='file', id=file.id) }}">
                                <bottom class="btn btn-danger">删除</bottom>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 文件上传表单 -->
        <form action="{{ url_for('app.upload') }}" class="dropzone" id="file-upload-form"></form>
        <div class="form-group">
            <form action="{{ url_for('app.msg') }}" method="post">
                <label for="msg-input">Message:</label>
                <textarea class="form-control" id="msg-input" name="content" rows="1"></textarea>
                <button type="submit" class="btn btn-primary">Send</button>
            </form>

        </div>

        <div style="height: 20vh; overflow-y: auto;">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Message</th>
                        <th>Created At</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="msg-list">
                    {% for msg in msgs %}
                    <tr>
                        <td class="msg">
                            <pre>{{ msg.content }}</pre>
                        </td>
                        <td>{{ msg.created_at|datetime_format }}</td>
                        <td>
                            <bottom class="copy-btn btn btn-success">复制</bottom>
                            <a href="/delete/msg/{{ msg.id }}">
                                <bottom class="btn btn-danger">删除</bottom>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>




    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/dropzone/5.9.2/min/dropzone.min.js"></script>
    <script>
        Dropzone.autoDiscover = false;
        var myDropzone = new Dropzone("#file-upload-form", {
            paramName: "uploaded_file", // The name that will be used to transfer the file
            maxFilesize: 0, // MB
            addRemoveLinks: true,
            dictDefaultMessage: "Drop files here or click to upload.",
            dictRemoveFile: "Remove",
            //acceptedFiles: ".jpg, .jpeg, .png, .gif, .bmp, .pdf, .doc, .docx, .txt, .zip, .rar",
            contentType: "multipart/form-data",
            init: function () {
                this.on("sending", function (file, xhr) {
                    xhr.timeout = 1800000;
                })
                // 设置上传成功后的回调函数
                this.on("success", function (file, response) {
                    // 在文件列表中添加新上传的文件
                    var tbody = document.getElementById("files");
                    tbody.insertAdjacentHTML('afterbegin', response);
                });
            }
        });

        document.querySelectorAll('.copy-btn').forEach(function (btn) {
            btn.addEventListener('click', function (ev) {
                var content = this.parentNode.parentNode.querySelector('.msg').textContent.trim();
                navigator.clipboard.writeText(content).then(function () {
                    console.log('复制成功');
                }, function (err) {
                    console.log('复制失败', err);
                });
            });
        });

        // 固定上传文件框在屏幕最下方
        $(document).ready(function () {
            $(window).on('scroll', function () {
                var scrollBottom = $(document).height() - $(window).scrollTop() - $(window).height();
                if (scrollBottom < 150) {
                    $('.dropzone').removeClass('fixed-bottom');
                } else {
                    $('.dropzone').addClass('fixed-bottom');
                }
            });
        });
    </script>
</body>

</html>