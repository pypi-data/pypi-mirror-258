import{formatters,submitLoading,initBootstrapTable}from"../commons/index.min.js";import{BASE_WEBSOCKET_URL,startWebsocket}from"../commons/websockets.min.js";import{calculateDuration,taskFormatters}from"../commons/celery.min.js";const tableId="task-list",tableElem=document.getElementById(tableId),actionElem=document.getElementById("task-list-action");function onMessage(t){if(t.tasks)for(var e of t.tasks)appendOrUpdate(e);t.task&&appendOrUpdate(t.task)}function appendOrUpdate(t){table.bootstrapTable("getRowByUniqueId",t.id)?table.bootstrapTable("updateByUniqueId",{id:t.id,row:t}):table.bootstrapTable("append",t)}function prepareTable(){return initBootstrapTable(tableId,{uniqueId:"id",clickToSelect:!0,fields:{_checkbox:{checkbox:!0,sortable:!1},id:{formatter:taskFormatters.shortId},state:{formatter:taskFormatters.state},progress:{formatter:taskFormatters.progress},start:{formatter:formatters.date},end:{formatter:formatters.date},duration:{formatter:taskFormatters.duration}}})}function updateTaskDurations(){setTimeout(()=>{var t;tableElem.querySelectorAll(".task-duration").forEach(t=>t.innerHTML="-");for(t of table.bootstrapTable("getData",{useCurrentPage:!0,includeHiddenRows:!1})){var e=tableElem.querySelector(`.task-duration[data-task-id="${t.id}"]`);e&&(e.innerHTML=calculateDuration(t.start,t.end)??"-")}updateTaskDurations()},900)}function bindActions(){actionElem.form.addEventListener("submit",t=>{t.preventDefault();const e={};if(e.action=actionElem.options[actionElem.selectedIndex].value,e.action){const a=table.bootstrapTable("getSelections").map(t=>t.id);e.task_ids=a.join(";"),e.task_ids.length&&submitLoading(actionElem.form,{data:e,successMessage:!0,onSuccess:()=>{if("forget"==e.action)for(const t of a)table.bootstrapTable("removeByUniqueId",t)}})}})}function bindLaunchTask(){const e=document.getElementById("task-launch");e.addEventListener("submit",t=>{t.preventDefault(),submitLoading(e,{successMessage:!0})});var t=document.getElementById("task-launch-name");$(t).select2({theme:"bootstrap-5",placeholder:t.dataset.placeholder,allowClear:!0,tags:!0})}let table=prepareTable();updateTaskDurations(),bindActions(),bindLaunchTask();const path=window.location.pathname.startsWith("/task")?"/ws/task/":"/zut/ws/task/";startWebsocket(""+BASE_WEBSOCKET_URL+path,{onMessage:onMessage,name:"tasks",reconnectButton:!0});
//# sourceMappingURL=celery_task_list.min.js.map