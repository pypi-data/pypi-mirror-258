<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <title>Structured Data Readiness</title>
</head>
<body>
    <h1>Structured Data Readiness</h1>
    <form id="uploadForm" method="post" enctype="multipart/form-data">
        <label for="file">Choose a CSV file:</label>
        <input type="file" name = 'file' id="file" accept=".csv" required>

        <div id="summaryStatistics"></div>
        <div class="plot-container" id="histogramsContainer"></div>

        <strong id="toggleButton_quality" onclick="toggleCheckboxes('checkboxContainer_quality','quality')"> + </strong>
        <strong>Data Quality Metrics</strong> <br>
        <div id="checkboxContainer_quality" class="checkboxContainer"><br>
            <div style="margin-left: 40px;">
                <input type="checkbox" name="completeness" value="yes"> Check completeness
                <input type="checkbox" name="outliers" value="yes" style="margin-left: 40px;"> Check outliers
                <input type="checkbox" name="duplicity" value="yes" style="margin-left: 40px;"> Check duplicity
            </div>
             
        </div>
        <br>

        <strong id="toggleButton_fairness" onclick="toggleCheckboxes('checkboxContainer_fairness','fairness')"> + </strong>
        <strong>Fairness Metrics</strong> <br>
        <div id="checkboxContainer_fairness" class="checkboxContainer"><br>
            <input style="margin-left: 40px;" type="checkbox" name="representation rate" value="yes"> Check representation rate<br>

            <ul>
                <li style="margin-left: 40px;" >
                    <label for="features for representation rate">Sensitive feature:</label>
                    <select name="features for representation rate" id = "allFeaturesDropdownRepRate" required>
                        <option value="" disabled selected>Select a feature</option>
                        <!-- Options will be added dynamically using JavaScript -->
                    </select>
            
                </li>
            </ul>

            
            <input style="margin-left: 40px;" type="checkbox" name="statistical rate" value="yes"> Check statistical rate<br>
            <ul>
                <li style="margin-left: 40px;">
                    <label for="features for statistical rate">Feature:</label>
                    <select name="features for statistical rate" id = "allFeaturesDropdownStatRate1" required>
                        <option value="" disabled selected>Select a feature</option>
                    </select>
                </li>
                <li style="margin-left: 40px;">
                    <label for="target for statistical rate">Target:</label>
                    <select name="target for statistical rate" id = "allFeaturesDropdownStatRate2" required>
                        <option value="" disabled selected>Select a feature</option>
                    </select><br>
                </li>
                
            </ul>
            
            <!-- <input style="margin-left: 40px;" type="checkbox" name="real representation rate" value="yes"> Check real world representation rate<br> -->
            
            <!-- <ul>
                <li style="margin-left: 40px;">
                    <label for="real column">Sensitive Feature:</label>
                    <select name="real column" id = "allFeaturesDropdownRealRep" required>
                        <option value="" disabled selected>Select a feature</option>
                    </select><br>
                </li>

                <li style="margin-left: 40px;">
                    <label for="real attributes">Sensitive groups:</label>
                    <input type="text" name="real attributes">
                </li>

                <li style="margin-left: 40px;">
                    <label for="real values">Values of Sensitive groups:</label>
                    <input type="text" name="real values"><br>
                </li>
            </ul> -->

            
            
            
            
            <!-- <input style="margin-left: 40px;" type="checkbox" name="compare real to dataset" value="yes"> Compare real world to dataset representation rates<br> -->
        </div>        
        <br>

        <strong id="toggleButton_correlation" onclick="toggleCheckboxes('checkboxContainer_correlation','correlation')"> + </strong>
        <strong>Correlation Analysis</strong> <br>
        <div id="checkboxContainer_correlation" class="checkboxContainer"><br>
            <input style="margin-left: 40px;" type="checkbox" name="correlations" value="yes"> Perform Correlation Analysis<br>

            <ul>
                <li style="margin-left: 40px;">
                    <label for="correlationColumns">Features:</label>
                    <!-- Checkboxes for correlations -->
                    <div style="margin-left: 40px;" id="correlationCheckboxContainer"></div>
                </li>
            </ul>
           
        </div>
        <br>

        <strong id="toggleButton_featureRelevance" onclick="toggleCheckboxes('checkboxContainer_featureRelevance','featureRelevance')"> + </strong>
        <strong>Feature Relevance</strong> <br>
        <div id="checkboxContainer_featureRelevance" class="checkboxContainer"><br>

            <input style="margin-left: 40px;" type="checkbox" name="feature relevancy" value="yes"> Check feature relavancy against target<br>

            <ul>
                <li style="margin-left: 40px;">
                    <label  for="categorical features for feature relevancy">Categorical features:</label>
                    <div id ="catFeaturesCheckbox1"></div><br>
                </li>

                <li style="margin-left: 40px;">
                    <label  for="numerical features for feature relevancy">Numerical features:</label>
                    <div  id ="numFeaturesCheckbox1"></div><br>
                </li>

                <li style="margin-left: 40px;">
                    <label  for="target for feature relevance">Target feature:</label>
                    <select name="target for feature relevance" id = "allFeaturesDropdownFeaRel"required>
                        <option value="" disabled selected>Select a feature</option>
                        <!-- Options will be added dynamically using JavaScript -->
                    </select><br>
                </li>
            </ul>
        
                    
        </div>
        <br>      

        <strong id="toggleButton_classImbalance" onclick="toggleCheckboxes('checkboxContainer_classImbalance','classImbalance')"> + </strong>
        <strong>Class Imbalance</strong> <br>
        <div id="checkboxContainer_classImbalance" class="checkboxContainer"><br>
        <input style="margin-left: 40px;" type="checkbox" name="class imbalance" value="yes">Evaluate imbalance degree<br>
        <ul>
            <li  style="margin-left: 40px;">
                <label for="class imbalance">Target: </label>
                <select name="class feature" id="allFeaturesDropdownClIm" required>
                    <option value ="" disabled selected>Select a feature</option>
                </select><br>
            </li>
        </ul>
            
        </div>
        <br>

        
        
        <strong id="toggleButton_privacy" onclick="toggleCheckboxes('checkboxContainer_privacy','privacy')"> + </strong>
        <strong>Privacy Preservation</strong> <br>
        <div id="checkboxContainer_privacy" class="checkboxContainer"><br> 
            <input style="margin-left: 40px;" type="checkbox" name="differential privacy" value="yes"> Differential privacy by adding laplacian noise:<br>
            <ul>
                <li  style="margin-left: 40px;" >
                    <label for="numerical features to add noise">Numerical features to add noise:</label>
                    <div id ="numFeaturesCheckbox2"></div>
                </li>

                <li  style="margin-left: 40px;" >
                    <label for="privacy budget">Privacy budget (epsilon):</label>
                    <input type="text" name="privacy budget">
                </li>
            </ul>
            
            
            <input style="margin-left: 40px;" type="checkbox" name="single attribute risk score" value="yes"> Evaluate single attribute risks:<br>
            
            <ul>
                <li  style="margin-left: 40px;" >
                    <label for="id feature to measure single attribute risk score">ID feature: </label>
                    <select name="id feature to measure single attribute risk score" id="allFeaturesDropdownMMS" required>
                        <option value ="" disabled selected>Select a feature</option>
            </select><br>
                </li>

                <li  style="margin-left: 40px;" >
                    <label for="privacy budget">Privacy budget (epsilon):</label>
                    <input type="text" name="privacy budget">
                </li>

                <li style="margin-left: 40px;">
                    <label  for="quasi identifiers to measure single attribute risk score">Quasi identifiers: </label>
                    <div id ="catFeaturesCheckbox2"></div><br>
                </li>
            </ul>
            
            
            

            <input style="margin-left: 40px;" type="checkbox" name="multiple attribute risk score" value="yes"> Evaluate multiple attribute risks:<br>
            
            <ul>
                <li style="margin-left: 40px;">
                    <label for="id feature to measure multiple attribute risk score">ID feature</label>
                    <select name="id feature to measure multiple attribute risk score" id="allFeaturesDropdownMMM" required>
                        <option value ="" disabled selected>Select a feature</option>
                    </select><br>
                </li>

                <li style="margin-left: 40px;">
                    <label for="quasi identifiers to measure multiple attribute risk score">Quasi identifiers: </label>
                    <div  id ="catFeaturesCheckbox3"></div><br>
                </li>
            </ul>
            
            
            
        </div>
        <br>        

        <strong id="toggleButton_FAIRness" onclick="toggleCheckboxes('checkboxContainer_FAIRness','FAIRness')"> + </strong>
        <strong>FAIRness Evaluation</strong> <br>
        <div id="checkboxContainer_FAIRness" class="checkboxContainer"><br>
            <button type="button" onclick="window.location.href='/FAIRness'">Check FAIRness scores</button><br>

        </div> <br>



        <div id = "formbuttonsContainer">
            <button type="button" onclick="submitForm()">Submit</button>
    
            <!-- Reset button with event listener -->
            <button type="reset" value="Reset" id="resetButton" style="background-color: red;">Reset</button>
        </div>
        
        
        <div id="buttonsContainer" style="display:none;">
            <button type="button" id="visualizationBtn" onclick="showVisualization()">Show Visualization</button>
            <button type="button" id="jsonBtn" onclick="showResults()">Show Results</button>
            <button type="button" id="downloadBtn" onclick="downloadJSON()">Download JSON</button>
        </div>
        
    </form>
    
            

        </div>

    
    <div id="resultContainer" style="display:none;"></div>
    

    <script>

        $(document).ready(function () {
            $('#file').on('change', function () {
                var fileInput = document.getElementById('file');
                var file = fileInput.files[0];

                var formData = new FormData();
                formData.append('file', file);

                $.ajax({
                    url: '/summary_statistics',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        if (response.success) {

                            // Check if either categorical or numerical features exist in the response
                            if ('categorical_features' in response) {
                                createDropdown(response.categorical_features, 'catFeaturesDropdown');
                                createCheckboxContainer(response.categorical_features,'catFeaturesCheckbox1','categorical features for feature relevancy')
                                createCheckboxContainer(response.categorical_features,'catFeaturesCheckbox2','quasi identifiers to measure single attribute risk score')
                                createCheckboxContainer(response.categorical_features,'catFeaturesCheckbox3','quasi identifiers to measure multiple attribute risk score')

                            }

                            if ('numerical_features' in response) {
                                createDropdown(response.numerical_features, 'numFeaturesDropdownFeaRel');
                                createDropdown(response.numerical_features, 'numFeaturesDropdownPriv');
                                createCheckboxContainer(response.numerical_features,'numFeaturesCheckbox1','numerical features for feature relevancy')
                                createCheckboxContainer(response.numerical_features,'numFeaturesCheckbox2',"numerical features to add noise")
                            }

                            if ('all_features' in response){
                                createDropdown(response.all_features,'allFeaturesDropdownRepRate');
                                createDropdown(response.all_features,'allFeaturesDropdownStatRate1');
                                createDropdown(response.all_features,'allFeaturesDropdownStatRate2');
                                createDropdown(response.all_features,'allFeaturesDropdownRealRep');
                                createDropdown(response.all_features,'allFeaturesDropdownFeaRel');
                                createDropdown(response.all_features,'allFeaturesDropdownClIm');
                                createDropdown(response.all_features,'allFeaturesDropdownMMS');
                                createDropdown(response.all_features,'allFeaturesDropdownMMM');
                            }

                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            });

            function createDropdown(features, dropdownId) {
                var dropdown = $('#' + dropdownId);
                dropdown.empty(); // Clear previous options

                // Add default options
                dropdown.append($('<option value="" disabled>Select a feature</option>'));

                // Populate the dropdown with options from the response
                for (var i = 0; i < features.length; i++) {
                    dropdown.append($('<option>').text(features[i]));
                }
            }
            function createCheckboxContainer(features, tableId, nameTag) {
               
                var table = $('#' + tableId);
                table.empty(); // Clear previous content

                var columns = 4; // Maximum number of columns

                for (var i = 0; i < features.length; i++) {
                    if (i % columns === 0) {
                        var row = $('<tr>');
                        table.append(row);
                    }

                    var checkbox = $('<input>').attr({
                        type: 'checkbox',
                        id: 'checkbox_' + i, // You may want to generate unique IDs
                        name: nameTag, // Set the name attribute
                        value: features[i]
                    });

                    var label = $('<label>').attr('for', 'checkbox_' + i).text(features[i]);

                    var cell = $('<td>').append(checkbox).append(label);

                    row.append(cell);
                }
            }
        });


        //generate summary statistics
        $(document).ready(function () {
            $('#file').on('change', function () {
                var fileInput = document.getElementById('file');
                var file = fileInput.files[0];
                

                var formData = new FormData();
                formData.append('file', file);
               
                $.ajax({
                    url: '/summary_statistics',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        if (response.success) {
                            
                            $('#recordsCount').text(response.records_count);
                            $('#catFeatures').text(response.categorical_features);
                            $('#numFeatures').text(response.numerical_features);
                           

                            // Display additional summary statistics
                            
                            var statisticsHTML = '<p id="Statresult"><strong>Number of Features:</strong> <span id="featuresCount">' + response.features_count + '</span></p>';
                            statisticsHTML += '<p id="Statresult"><strong>Number of Data Points:</strong> <span id="recordsCount">' + response.records_count + '</span></p>';
                            statisticsHTML += '<p id="Statresult"><strong>Categorical Features:</strong> <span id="catFeatures">' + response.categorical_features + '</span></p>';
                            statisticsHTML += '<p id="Statresult"><strong>Numerical Features:</strong> <span id="numFeatures">' + response.numerical_features + '</span></p><br>';
                            statisticsHTML += '<h3>Summary Statistics Table</h3><table>';
                            statisticsHTML += '<tr><th><strong>Statistic</strong></th>'; // Bold header for the "Statistic" column

                            // Iterate over the keys to create columns (excluding the first key)
                            for (var key in response.summary_statistics) {
                                statisticsHTML += '<th>' + key + '</th>';
                            }
                            statisticsHTML += '</tr>'; // End of the header row

                            // Iterate over the statistics for each key
                            for (var statKey in response.summary_statistics[key]) {
                                statisticsHTML += '<tr><td><strong>' + statKey + '</strong></td>'; // Bold row for the "Feature" column

                                // Iterate over the keys to get values for each column
                                for (var key in response.summary_statistics) {
                                    var statValue = response.summary_statistics[key][statKey];

                                    statisticsHTML += '<td>' + statValue + '</td>';
                                }
                                statisticsHTML += '</tr>'; // End of the row
                            }

                            statisticsHTML += '</table>';
                            $('#summaryStatistics').html(statisticsHTML);

                            // Display histograms
                            var histogramsContainer = $('#histogramsContainer');
                            histogramsContainer.empty();
                            histogramsContainer.append('<br><h3>Summary Statistic Plots</h3>'); // Add heading for histograms

                            for (var feature in response.histograms) {
                                var base64Image = response.histograms[feature];
                                var img = document.createElement('img');
                                img.src = 'data:image/png;base64,' + base64Image;
                                img.alt = feature + ' Histogram';
                                histogramsContainer.append(img);
                            }
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            });
        });

        //generate dropdown when features of the dataset are required to select
        $(document).ready(function() {
            $('input[type="file"]').change(function(e) {
                var fileInput = $(this);
                var file = fileInput.prop('files')[0];

                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var content = e.target.result;
                        var lines = content.split('\n');
                        if (lines.length > 0) {
                            var columns = lines[0].split(',');
                            displayColumns(columns);
                        }
                    };
                    reader.readAsText(file);
                }
            });

            var checkboxesLoaded = false;

            function displayColumns(columns) {

                // Checkboxes
                if (!checkboxesLoaded) {
                    var checkboxContainer = $('#correlationCheckboxContainer');
                    var table = $('<table>').appendTo(checkboxContainer);
                    var row, cell;

                    for (var i = 0; i < columns.length; i++) {
                        if (i % 4 === 0) {
                            // Start a new row for every 4 columns
                            row = $('<tr>').appendTo(table);
                        }

                        cell = $('<td>').appendTo(row);
                        var checkbox = $('<input type="checkbox" class="columnCheckbox">')
                            .attr('id', 'checkbox_' + columns[i])
                            .attr('value', columns[i])
                            .attr('name', 'checkboxValues');

                        var label = $('<label>')
                            .attr('for', 'checkbox_' + columns[i])
                            .text(columns[i]);

                        cell.append(checkbox);
                        cell.append(label);
                    }

                    checkboxesLoaded = true;
                }
            }
        });

        document.getElementById('resetButton').addEventListener('click', function() {
            // // Clear form fields
            // document.getElementById('uploadForm').reset();

            // // Clear dropdowns
            // clearDropdown('allFeaturesDropdownRepRate');
            // clearDropdown('allFeaturesDropdownStatRate1');
            // clearDropdown('allFeaturesDropdownStatRate2');
            // clearDropdown('allFeaturesDropdownRealRep');
            // clearDropdown('catFeaturesDropdown');
            // clearDropdown('numFeaturesDropdownFeaRel');
            // clearDropdown('allFeaturesDropdownFeaRel');
            // clearDropdown('numFeaturesDropdownPriv');
            
            // // Clear text inputs
            // document.getElementsByName('real attributes')[0].value = '';
            // document.getElementsByName('real values')[0].value = '';
            // document.getElementsByName('privacy budget')[0].value = '';

            // // Clear summary statistics and histograms
            // $('#summaryStatistics').empty();
            // $('#histogramsContainer').empty();

            // Simulate a page reload including cache clearing
            location.reload(true); // Pass true to force a reload from the server and not from the cache
        });

        function clearDropdown(dropdownId) {
            var dropdown = document.getElementById(dropdownId);
            dropdown.selectedIndex = 0;
            // Additional logic to clear dynamically added options if needed
        }

</script>

</body>
</html>
