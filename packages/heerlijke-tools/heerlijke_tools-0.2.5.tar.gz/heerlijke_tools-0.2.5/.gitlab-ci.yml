image: heerlijkeheer/python-rye:0.0.2

stages:
  - build
  - publish

build:
  stage: build
  script:
    - rye build
  artifacts:
    paths:
      - dist/*
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /publish/"
      when: on_success
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_COMMIT_BRANCH'
      when: never

publish:
  stage: publish
  dependencies:
    - build
  script:
    - rye publish --token $PYPI_TOKEN --yes
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_COMMIT_BRANCH'
      when: never
