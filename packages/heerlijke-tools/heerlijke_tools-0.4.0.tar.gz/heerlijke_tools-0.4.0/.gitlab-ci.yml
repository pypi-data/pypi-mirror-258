image: heerlijkeheer/python-rye:0.0.2


stages:
  - security
  - build
  - publish

verify-commit-signature:
  stage: security
  script:
    - |
      if git log -1 --pretty=format:"%G?" $CI_COMMIT_SHA...HEAD | grep -qv "G"; then
        echo "Commit is not signed!"
        exit 1
      else
        echo "Commit is signed."
      fi
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_COMMIT_BRANCH'
      when: on_success

build:
  stage: build
  script:
    - rye build
  artifacts:
    paths:
      - dist/*
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /publish/"
      when: on_success
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_COMMIT_BRANCH'
      when: never

publish:
  stage: publish
  dependencies:
    - build
  script:
    - rye publish --token $PYPI_TOKEN --yes
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_COMMIT_BRANCH'
      when: never

pages:
  stage: build
  script:
    - rye sync
    - rye run mkdocs build --site-dir public
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_TAG'
      when: never
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - mkdocs.yml
        - docs/**/*
